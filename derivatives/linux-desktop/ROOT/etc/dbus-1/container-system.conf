<!DOCTYPE busconfig PUBLIC
 "-//freedesktop//DTD D-Bus Bus Configuration 1.0//EN"
 "http://www.freedesktop.org/standards/dbus/1.0/busconfig.dtd">
<busconfig>
  <type>system</type>

  <!-- Basic configuration -->
  <user>messagebus</user>
  <listen>unix:path=/var/run/dbus/system_bus_socket</listen>

  <standard_system_servicedirs/>
  <servicehelper>/usr/lib/dbus-1.0/dbus-daemon-launch-helper</servicehelper>

  <!-- Default policy - allow general communication but ONLY block power management -->
  <policy context="default">
    <!-- Core D-Bus functionality -->
    <allow send_destination="org.freedesktop.DBus"/>
    <allow receive_sender="org.freedesktop.DBus"/>
    
    <!-- Allow most service communication by default -->
    <allow send_type="method_call"/>
    <allow send_type="method_return"/>
    <allow send_type="signal"/>
    <allow send_type="error"/>
    <allow receive_type="method_call"/>
    <allow receive_type="method_return"/>
    <allow receive_type="signal"/>
    <allow receive_type="error"/>
    
    <!-- Block ONLY power management related services -->
    
    <!-- systemd power management - allow the service but block power actions -->
    <allow send_destination="org.freedesktop.systemd1"/>
    <allow receive_sender="org.freedesktop.systemd1"/>
    
    <!-- Only block specific power management methods -->
    <deny send_destination="org.freedesktop.systemd1"
          send_interface="org.freedesktop.systemd1.Manager"
          send_member="PowerOff"/>
    <deny send_destination="org.freedesktop.systemd1"
          send_interface="org.freedesktop.systemd1.Manager"
          send_member="Reboot"/>
    <deny send_destination="org.freedesktop.systemd1"
          send_interface="org.freedesktop.systemd1.Manager"
          send_member="Suspend"/>
    <deny send_destination="org.freedesktop.systemd1"
          send_interface="org.freedesktop.systemd1.Manager"
          send_member="Hibernate"/>
    <deny send_destination="org.freedesktop.systemd1"
          send_interface="org.freedesktop.systemd1.Manager"
          send_member="HybridSleep"/>
    
    <!-- login1 power management - allow the service but block power actions -->
    <allow send_destination="org.freedesktop.login1"/>
    <allow receive_sender="org.freedesktop.login1"/>
    
    <!-- Only block specific power management methods -->
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="PowerOff"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="Reboot"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="Suspend"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="Hibernate"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="HybridSleep"/>
    
    <!-- UPower -->
    <deny send_destination="org.freedesktop.UPower"/>
    <deny own="org.freedesktop.UPower"/>
    
    <!-- Power Profiles Daemon -->
    <deny send_destination="net.hadess.PowerProfiles"/>
    <deny own="net.hadess.PowerProfiles"/>
    
    <!-- GNOME power management -->
    <deny send_destination="org.gnome.PowerManager"/>
    <deny own="org.gnome.PowerManager"/>
    <deny send_destination="org.gnome.SessionManager.Presence"/>
    <deny own="org.gnome.SessionManager.Presence"/>
    
    <!-- KDE power management -->
    <deny send_destination="org.kde.powerdevil"/>
    <deny own="org.kde.powerdevil"/>
    <deny send_destination="org.kde.Solid.PowerManagement"/>
    <deny own="org.kde.Solid.PowerManagement"/>
    
    <!-- TLP power management -->
    <deny send_destination="org.freedesktop.thermald"/>
    <deny own="org.freedesktop.thermald"/>
    
    <!-- NetworkManager power management -->
    <deny send_destination="org.freedesktop.NetworkManager.sleep.conf"/>
    <deny own="org.freedesktop.NetworkManager.sleep.conf"/>
    
    <!-- Laptop mode tools -->
    <deny send_destination="org.laptop_mode.tools"/>
    <deny own="org.laptop_mode.tools"/>
    
    <!-- Intel power management -->
    <deny send_destination="com.intel.dptf"/>
    <deny own="com.intel.dptf"/>
  </policy>

  <!-- Root policy - allow everything except what we explicitly deny -->
  <policy user="root">
    <allow own="*"/>
    <allow send_type="*"/>
    <allow receive_type="*"/>
    
    <!-- Allow systemd and login1 services to be owned by root -->
    <allow own="org.freedesktop.systemd1"/>
    <allow own="org.freedesktop.login1"/>
    
    <!-- Explicitly deny power management services even for root -->
    <deny own="org.freedesktop.UPower"/>
    <deny own="net.hadess.PowerProfiles"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="PowerOff"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="Reboot"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="Suspend"/>
    <deny send_destination="org.freedesktop.login1"
          send_interface="org.freedesktop.login1.Manager"
          send_member="Hibernate"/>
  </policy>

  <!-- PolicyKit needs special permissions -->
  <policy user="polkitd">
    <allow own="org.freedesktop.PolicyKit1"/>
    <allow send_destination="*"/>
    <allow receive_sender="*"/>
  </policy>

  <!-- Allow special groups their necessary permissions -->
  <policy group="disk">
    <allow send_destination="org.freedesktop.UDisks2"/>
    <allow receive_sender="org.freedesktop.UDisks2"/>
  </policy>

</busconfig>