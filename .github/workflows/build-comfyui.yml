# Build ComfyUI image - works on main repo (scheduled + manual) and forks (manual)
# Required repository secrets:
# DOCKERHUB_USERNAME
# DOCKERHUB_TOKEN
# Optional:
# SLACK_WEBHOOK_URL

name: Build ComfyUI Image

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: '0 6 * * *'
  
  workflow_dispatch:
    inputs:
      COMFYUI_REF:
        description: "ComfyUI git ref (tag, branch, or commit)"
        required: true
        default: "master"
      DOCKERHUB_REPO:
        description: "Push to username/<repo>"
        required: true
        default: "comfy"
      MULTI_ARCH:
        description: 'multi-arch build'
        required: false
        default: true
        type: boolean
      CUSTOM_IMAGE_TAG:
        description: "Custom tag (Auto default)"
        required: false

env:
  DEFAULT_COMFYUI_REF: "master"
  DEFAULT_DOCKERHUB_REPO: "comfy"
  DEFAULT_MULTI_ARCH: "true"
  # 1 day
  RELEASE_AGE_THRESHOLD: 86400

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      should-run: ${{ steps.decision.outputs.should-run }}
      latest-release-tag: ${{ steps.release-check.outputs.tag }}
      comfyui-ref: ${{ steps.resolve-ref.outputs.comfyui-ref }}
    steps:
      - name: Check for required secrets
        id: secrets
        run: |
          if [[ -n "${{ secrets.DOCKERHUB_USERNAME }}" && -n "${{ secrets.DOCKERHUB_TOKEN }}" ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
            echo "✓ Required secrets are configured"
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::notice::Skipping build - DOCKERHUB_USERNAME and/or DOCKERHUB_TOKEN secrets not configured"
          fi

      - name: Check for new ComfyUI release
        id: release-check
        if: github.event_name == 'schedule'
        run: |
          echo "Checking for new ComfyUI releases..."
          
          HTTP_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Comfy-Org/ComfyUI/releases/latest)
          
          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
          BODY=$(echo "$HTTP_RESPONSE" | sed '$d')
          
          # Handle API errors gracefully - skip build
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::warning::GitHub API returned $HTTP_CODE - skipping build"
            echo "new-release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PUBLISHED_AT=$(echo "$BODY" | jq -r '.published_at // empty')
          TAG=$(echo "$BODY" | jq -r '.tag_name // empty')
          
          if [[ -z "$PUBLISHED_AT" || -z "$TAG" ]]; then
            echo "::warning::Could not parse release data - skipping build"
            echo "new-release=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Calculate release age
          RELEASE_EPOCH=$(date -d "$PUBLISHED_AT" +%s)
          NOW_EPOCH=$(date +%s)
          AGE=$((NOW_EPOCH - RELEASE_EPOCH))
          AGE_DAYS=$((AGE / ${{ env.RELEASE_AGE_THRESHOLD }}))
          
          echo "Latest release: $TAG (published $AGE_DAYS days ago)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          if [[ $AGE -lt ${{ env.RELEASE_AGE_THRESHOLD }} ]]; then
            echo "new-release=true" >> $GITHUB_OUTPUT
            echo "✓ New release detected - will build"
          else
            echo "new-release=false" >> $GITHUB_OUTPUT
            echo "::notice::No new release in the last day - skipping build"
          fi

      - name: Resolve ComfyUI ref
        id: resolve-ref
        run: |
          # For scheduled runs with a new release, use the release tag
          if [[ "${{ github.event_name }}" == "schedule" && -n "${{ steps.release-check.outputs.tag }}" ]]; then
            REF="${{ steps.release-check.outputs.tag }}"
            echo "Using latest release tag: $REF"
          else
            REF="${{ inputs.COMFYUI_REF || env.DEFAULT_COMFYUI_REF }}"
            
            # Only resolve master to commit hash for manual triggers
            if [[ -z "$REF" ]] || [[ "$REF" == "master" ]]; then
              echo "Resolving ComfyUI master → HEAD commit"
              REF=$(git ls-remote https://github.com/Comfy-Org/ComfyUI.git refs/heads/master | cut -f1 | cut -c1-7)
              [[ -n $REF ]] || REF="$(date -u +%Y%m%d-%H%M)"
            fi
          fi

          echo "comfyui-ref=$REF" >> $GITHUB_OUTPUT
          echo "Using COMFYUI_REF=$REF"

      # Build stage must not be called if conditions not satisfied
      - name: Determine if build should run
        id: decision
        run: |
          SECRETS="${{ steps.secrets.outputs.available }}"
          
          # For manual dispatch, always build (skip release check)
          # For schedule, require new release
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            NEW_RELEASE="true"
          else
            NEW_RELEASE="${{ steps.release-check.outputs.new-release }}"
          fi
          
          if [[ "$SECRETS" == "true" && "$NEW_RELEASE" == "true" ]]; then
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "✓ Build will proceed"
          else
            echo "should-run=false" >> $GITHUB_OUTPUT
            echo "Build will be skipped"

            # Set reason for cancellation message
            if [[ "$SECRETS" != "true" ]]; then
              echo "reason=Required secrets not configured" >> $GITHUB_OUTPUT
            else
              echo "reason=No new ComfyUI release detected" >> $GITHUB_OUTPUT
            fi
          fi

      # Avoid marking non-build runs as successful
      - name: Cancel workflow if not needed
        if: steps.decision.outputs.should-run == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "::notice::Cancelling workflow - ${{ steps.decision.outputs.reason }}"
          gh run cancel ${{ github.run_id }} --repo ${{ github.repository }}
          
          # Give GitHub time to process the cancellation
          sleep 5

  build:
    needs: preflight
    if: needs.preflight.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.event_name == 'workflow_dispatch' && 'production' || '' }}

    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        # Update these over time - Should generally be latest release for ComfyUI
        # CUDA 13 has optimizations but many hosts still running 12.x drivers
        base_image:
          - vastai/pytorch:2.9.1-cu128-cuda-12.9-mini-py312
          - vastai/pytorch:2.9.1-cu130-cuda-13.1-mini-py312

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize build space
        uses: ./.github/actions/maximize-build-space

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Docker Hub login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Derive CUDA & Python versions
        id: meta
        run: |
          PYTORCH_BASE="${{ matrix.base_image }}"
          TAG="${PYTORCH_BASE##*:}"

          CUDA_VERSION=$(echo "$TAG" | sed -n 's/.*cuda-\([0-9.]*\).*/\1/p')
          PYTHON_VERSION=$(echo "$TAG" | sed -n 's/.*-py\([0-9]*\).*/py\1/p')

          if [ -z "$CUDA_VERSION" ] || [ -z "$PYTHON_VERSION" ]; then
            echo "Failed to parse base image: $PYTORCH_BASE"
            exit 1
          fi

          IMAGE_TAG_BASE="${{ inputs.CUSTOM_IMAGE_TAG }}"
          if [ -z "$IMAGE_TAG_BASE" ]; then
            IMAGE_TAG_BASE="${{ needs.preflight.outputs.comfyui-ref }}"
          fi

          IMAGE_TAG="${IMAGE_TAG_BASE}-cuda-${CUDA_VERSION}-${PYTHON_VERSION}"
          echo "PYTORCH_BASE=$PYTORCH_BASE" >> $GITHUB_ENV
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

          echo "Derived image tag: $IMAGE_TAG"

      - name: Build and push
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            MULTI_ARCH="${{ inputs.MULTI_ARCH }}"
          else
            MULTI_ARCH="${{ env.DEFAULT_MULTI_ARCH }}"
          fi
          
          DOCKERHUB_REPO="${{ inputs.DOCKERHUB_REPO || env.DEFAULT_DOCKERHUB_REPO }}"
          
          platforms="linux/amd64"
          [[ "$MULTI_ARCH" == "true" ]] && platforms+=",linux/arm64"

          cd derivatives/pytorch/derivatives/comfyui
          docker buildx build \
            --platform "$platforms" \
            --build-arg PYTORCH_BASE=${{ env.PYTORCH_BASE }} \
            --build-arg COMFYUI_REF=${{ needs.preflight.outputs.comfyui-ref }} \
            -t ${{ secrets.DOCKERHUB_USERNAME }}/${DOCKERHUB_REPO}:${{ env.IMAGE_TAG }} \
            . --push

  notify:
    needs: [preflight, build]
    if: always() && needs.preflight.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Check for Slack webhook
        id: slack-check
        run: |
          if [[ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::notice::Slack webhook not configured - skipping notification"
          fi

      - name: Notify Slack
        if: steps.slack-check.outputs.available == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          # Determine build status
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            STATUS_EMOJI="✅"
            STATUS_TEXT="Successful"
            COLOR="good"
          else
            STATUS_EMOJI="❌"
            STATUS_TEXT="Failed"
            COLOR="danger"
          fi
          
          # Build image tag info
          COMFYUI_REF="${{ needs.preflight.outputs.comfyui-ref }}"
          DOCKERHUB_REPO="${{ inputs.DOCKERHUB_REPO || env.DEFAULT_DOCKERHUB_REPO }}"
          
          TAG_CUDA_12="${DOCKERHUB_USERNAME}/${DOCKERHUB_REPO}:${COMFYUI_REF}-cuda-12.9-py312"
          TAG_CUDA_13="${DOCKERHUB_USERNAME}/${DOCKERHUB_REPO}:${COMFYUI_REF}-cuda-13.1-py312"
          
          # Build base blocks
          BLOCKS=$(jq -n \
            --arg emoji "$STATUS_EMOJI" \
            --arg status "$STATUS_TEXT" \
            --arg trigger "${{ github.event_name }}" \
            --arg ref "$COMFYUI_REF" \
            --arg run_url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": ($emoji + " ComfyUI Image Build " + $status),
                  "emoji": true
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": ("*Trigger:*\n`" + $trigger + "`")
                  },
                  {
                    "type": "mrkdwn",
                    "text": ("*ComfyUI Ref:*\n`" + $ref + "`")
                  }
                ]
              }
            ]')
          
          # Add success-only blocks
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            SUCCESS_BLOCKS=$(jq -n \
              --arg tag12 "$TAG_CUDA_12" \
              --arg tag13 "$TAG_CUDA_13" \
              '[
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ("*Image Tags:*\n`" + $tag12 + "`\n`" + $tag13 + "`")
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "⚠️ *Recommended Template has not been modified.* Test new images before setting the default tag."
                  }
                }
              ]')
            BLOCKS=$(echo "$BLOCKS" | jq --argjson success "$SUCCESS_BLOCKS" '. + $success')
          fi
          
          # Add context block (always last)
          CONTEXT_BLOCK=$(jq -n \
            --arg url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            '[{
              "type": "context",
              "elements": [{
                "type": "mrkdwn",
                "text": ("<" + $url + "|View workflow run>")
              }]
            }]')
          BLOCKS=$(echo "$BLOCKS" | jq --argjson ctx "$CONTEXT_BLOCK" '. + $ctx')
          
          # Build final payload
          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --argjson blocks "$BLOCKS" \
            '{
              "attachments": [{
                "color": $color,
                "blocks": $blocks
              }]
            }')
          
          # Send notification
          curl -sfS -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD"

