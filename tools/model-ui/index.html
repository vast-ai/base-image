<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Model UI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%232563eb'/></svg>">
    <script id="config" type="application/json">__CONFIG_JSON__</script>
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg: rgb(249, 250, 251);
            --surface: #ffffff;
            --text: rgb(17, 24, 39);
            --text-secondary: rgb(75, 85, 99);
            --text-tertiary: rgb(107, 114, 128);
            --border: rgb(229, 231, 235);
            --border-light: #f3f4f6;
            --accent: rgb(47, 73, 208);
            --accent-hover: rgb(72, 101, 250);
            --accent-light: rgba(47, 73, 208, 0.06);
            --accent-muted: rgba(47, 73, 208, 0.3);
            --danger: rgb(239, 68, 68);
            --radius: 0.5rem;
            --radius-sm: 0.375rem;
            --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'SF Mono', SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: rgb(17, 24, 39);
                --surface: rgb(31, 41, 55);
                --text: rgb(243, 244, 246);
                --text-secondary: rgb(209, 213, 219);
                --text-tertiary: rgb(156, 163, 175);
                --border: rgb(55, 65, 81);
                --border-light: rgb(42, 52, 66);
                --accent: rgb(72, 101, 250);
                --accent-hover: rgb(105, 130, 253);
                --accent-light: rgba(72, 101, 250, 0.1);
                --accent-muted: rgba(72, 101, 250, 0.3);
                --danger: rgb(239, 68, 68);
                --card-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
            }
        }

        body {
            font-family: var(--font);
            background: var(--bg);
            color: var(--text);
            font-size: 14px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
        }

        /* Layout */
        #app {
            max-width: min(1200px, 95vw);
            margin: 0 auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--surface);
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
        }

        /* Header */
        header {
            padding: 0.875rem 1.25rem 0.625rem;
            border-bottom: 1px solid var(--border);
        }
        header h1 {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.3;
        }
        .model-id {
            font-size: 0.6875rem;
            color: var(--text-tertiary);
            font-family: var(--font-mono);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            padding: 0 1.25rem;
        }
        .tab-btn {
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.5rem 0.875rem;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.15s, border-color 0.15s;
            font-family: var(--font);
        }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Panels */
        main { flex: 1; min-height: 0; display: flex; flex-direction: column; }
        .tab-panel { display: none; flex: 1; min-height: 0; }
        .tab-panel.active { display: flex; flex-direction: column; }

        /* Forms */
        .field { margin-bottom: 0.625rem; }
        .field > label, label.field-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.1875rem;
        }
        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.4375rem 0.625rem;
            font-size: 0.8125rem;
            font-family: var(--font);
            color: var(--text);
            background: var(--surface);
            outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
            resize: vertical;
        }
        input:focus, textarea:focus, select:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent);
        }
        .range-row { display: flex; align-items: center; gap: 0.5rem; }
        .range-row input[type="range"] { flex: 1; accent-color: var(--accent); }
        .range-value {
            min-width: 3.5ch;
            text-align: right;
            font-size: 0.75rem;
            font-variant-numeric: tabular-nums;
            color: var(--text-secondary);
        }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.625rem; }

        /* Buttons */
        .btn-primary {
            display: inline-flex; align-items: center; justify-content: center;
            background: var(--accent); color: #fff; border: none;
            border-radius: var(--radius); padding: 0.4375rem 1rem;
            font-size: 0.8125rem; font-weight: 500; font-family: var(--font);
            cursor: pointer; transition: background 0.15s; white-space: nowrap;
        }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-primary:disabled { background: var(--accent-muted); cursor: not-allowed; }
        .btn-icon {
            display: inline-flex; align-items: center; justify-content: center;
            background: none; border: 1px solid var(--border); border-radius: var(--radius);
            width: 2rem; height: 2rem; cursor: pointer; font-size: 0.875rem;
            transition: background 0.15s; flex-shrink: 0;
        }
        .btn-icon:hover { background: var(--border-light); }
        .btn-link {
            background: none; border: none; color: var(--text-tertiary);
            font-size: 0.6875rem; cursor: pointer; padding: 0; font-family: var(--font);
        }
        .btn-link:hover { color: var(--text-secondary); text-decoration: underline; }

        /* Collapsible */
        details {
            border: 1px solid var(--border); border-radius: var(--radius);
            margin-bottom: 0.625rem; box-shadow: var(--card-shadow);
        }
        details > summary {
            padding: 0.4375rem 0.625rem; font-size: 0.75rem; font-weight: 500;
            color: var(--text-secondary); cursor: pointer; user-select: none;
            list-style: none;
        }
        details > summary::before { content: '\25B8\00a0'; }
        details[open] > summary::before { content: '\25BE\00a0'; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary { border-bottom: 1px solid var(--border); }
        .details-body { padding: 0.625rem; }

        /* Thinking blocks (reasoning models) */
        .think-block { box-shadow: none; background: var(--border-light); margin: 0.25rem 0 0.5rem; }
        .think-block > summary { font-weight: 400; color: var(--text-tertiary); font-style: italic; }
        .think-content {
            padding: 0.5rem 0.625rem; color: var(--text-tertiary);
            font-size: 0.8125rem; line-height: 1.6;
            max-height: 300px; overflow-y: auto;
        }

        /* Chat */
        .chat-container { flex: 1; display: flex; flex-direction: column; min-height: 0; }
        .chat-messages { flex: 1; overflow-y: auto; overscroll-behavior: contain; }
        .message { padding: 0.75rem 1.25rem; border-bottom: 1px solid var(--border-light); }
        .message:last-child { border-bottom: none; }
        .message.user { background: var(--accent-light); }
        .message-role {
            font-size: 0.625rem; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 0.0625rem;
        }
        .message-content { font-size: 0.875rem; line-height: 1.6; word-wrap: break-word; }
        .message-content pre {
            background: #1e1e1e; color: #d4d4d4; padding: 0.625rem 0.75rem;
            border-radius: var(--radius); overflow-x: auto;
            font-family: var(--font-mono); font-size: 0.75rem;
            line-height: 1.5; margin: 0.375rem 0;
        }
        .message-content code {
            background: var(--border-light); padding: 0.0625rem 0.25rem;
            border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 0.75rem;
        }
        .message-content pre code { background: none; padding: 0; border-radius: 0; }
        .chat-input-area { border-top: 1px solid var(--border); padding: 0.625rem 1.25rem; }
        .chat-input-area > textarea {
            width: 100%; resize: none; min-height: 3.5rem; max-height: 10rem;
            padding: 0.4375rem 0.625rem; line-height: 1.5;
            border: 1px solid var(--border); border-radius: var(--radius);
            font-size: 0.8125rem; font-family: var(--font); color: var(--text);
            background: var(--surface); outline: none;
            transition: border-color 0.15s, box-shadow 0.15s;
        }
        .chat-input-area > textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent);
        }
        .chat-actions {
            display: flex; justify-content: space-between; align-items: center;
            gap: 0.375rem; margin-top: 0.375rem;
        }
        .chat-actions .btn-primary { flex: 1; }
        .input-row { display: flex; gap: 0.375rem; align-items: flex-end; }
        .input-row textarea {
            flex: 1; resize: none; min-height: 2.25rem; max-height: 10rem;
            padding: 0.4375rem 0.625rem; line-height: 1.5;
        }
        .input-footer { display: flex; justify-content: flex-end; margin-top: 0.25rem; }
        .cursor-blink::after {
            content: '\2588'; animation: blink 1s step-end infinite; color: var(--text-tertiary);
        }
        @keyframes blink { 50% { opacity: 0; } }

        /* Image */
        .scroll-panel { padding: 1.25rem; overflow-y: auto; flex: 1; }

        /* Chat uploads */
        .chat-uploads { display: flex; gap: 0.375rem; flex-wrap: wrap; margin-bottom: 0.375rem; }
        .chat-uploads:empty { display: none; margin: 0; }
        .upload-thumb {
            position: relative; width: 3rem; height: 3rem;
            border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border);
        }
        .upload-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .upload-thumb .audio-badge {
            display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%; background: var(--border-light); font-size: 1rem;
        }
        .upload-thumb .remove-btn {
            position: absolute; top: -3px; right: -3px; width: 0.875rem; height: 0.875rem;
            border-radius: 50%; background: var(--danger); color: #fff; border: none;
            font-size: 0.5rem; cursor: pointer; display: flex;
            align-items: center; justify-content: center; line-height: 1;
        }

        /* Loading */
        .loading { display: inline-flex; gap: 0.1875rem; padding: 0.375rem 0; }
        .loading span {
            width: 5px; height: 5px; border-radius: 50%;
            background: var(--text-tertiary); animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading span:nth-child(1) { animation-delay: -0.32s; }
        .loading span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Error */
        .error-msg {
            color: var(--danger); font-size: 0.8125rem; padding: 0.375rem 0.625rem;
            background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius); margin-top: 0.375rem;
        }

        /* Lightbox */
        .lightbox {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.85); z-index: 1000;
            align-items: center; justify-content: center; cursor: zoom-out;
        }
        .lightbox.active { display: flex; }
        .lightbox img { max-width: 95vw; max-height: 95vh; object-fit: contain; border-radius: var(--radius); cursor: default; }

        .lb-nav {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.5); color: #fff; border: none;
            font-size: 2.5rem; padding: 0.5rem 0.75rem; cursor: pointer;
            border-radius: var(--radius); line-height: 1; z-index: 1001;
            transition: background 0.15s;
        }
        .lb-nav:hover { background: rgba(255,255,255,0.2); }
        .lb-prev { left: 1rem; }
        .lb-next { right: 1rem; }
        .lb-nav:disabled { opacity: 0.2; cursor: default; }

        /* Audio */
        audio { width: 100%; margin-top: 0.5rem; }
        audio:not([src]) { display: none; }

        /* Generation history */
        .gen-history { margin-top: 0.75rem; }
        #img-history {
            display: flex; flex-wrap: wrap; gap: 0.375rem;
        }
        #img-history img {
            height: 120px; width: auto; max-width: 100%; object-fit: cover;
            border-radius: var(--radius-sm); cursor: pointer; background: var(--border-light);
        }
        .gen-card {
            border: 1px solid var(--border); border-radius: var(--radius);
            margin-bottom: 0.625rem; overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        .gen-meta {
            display: flex; align-items: baseline; gap: 0.5rem;
            padding: 0.375rem 0.625rem; background: var(--border-light);
            border-bottom: 1px solid var(--border);
        }
        .gen-prompt {
            flex: 1; font-size: 0.75rem; font-style: italic; color: var(--text-secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .gen-time {
            font-size: 0.625rem; color: var(--text-tertiary);
            font-variant-numeric: tabular-nums; white-space: nowrap;
        }
        .gen-results { padding: 0.5rem; }
        .gen-results.gen-grid {
            display: flex; flex-wrap: wrap; gap: 0.375rem;
        }
        .gen-results img {
            height: 120px; width: auto; max-width: 100%; object-fit: cover;
            border-radius: var(--radius-sm); cursor: pointer; background: var(--border-light);
        }
        .gen-results video {
            max-height: 400px; width: 100%; border-radius: var(--radius);
        }
        .gen-results audio { width: 100%; margin-top: 0; }
        .history-footer {
            display: flex; justify-content: flex-end; margin-top: 0.25rem;
        }

        /* Payload editor */
        .payload-editor {
            width: 100%; background: #1e1e1e; color: #d4d4d4;
            font-family: var(--font-mono); font-size: 0.6875rem;
            line-height: 1.5; min-height: 12rem; resize: vertical;
            border: 1px solid #333; border-radius: var(--radius);
            padding: 0.5rem 0.625rem;
        }
        .payload-editor:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 20%, transparent);
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <h1 id="model-name"></h1>
            <div class="model-id" id="model-path"></div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" data-tab="chat">Chat</button>
            <button class="tab-btn" data-tab="image">Image</button>
            <button class="tab-btn" data-tab="video">Video</button>
            <button class="tab-btn" data-tab="tts">TTS</button>
        </nav>

        <main>
            <!-- Chat -->
            <section id="tab-chat" class="tab-panel active">
                <div class="chat-container">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <div class="chat-uploads" id="chat-uploads"></div>
                        <textarea id="chat-input" rows="1" placeholder="Type a message or attach files..."></textarea>
                        <input type="file" id="chat-file" accept="image/*,audio/*" multiple hidden>
                        <div class="chat-actions">
                            <button class="btn-icon" id="chat-attach" title="Attach image or audio">+</button>
                            <button id="chat-send" class="btn-primary">Send</button>
                        </div>
                        <div class="input-footer">
                            <button id="chat-clear" class="btn-link">Clear conversation</button>
                        </div>
                        <audio id="chat-audio" controls autoplay></audio>
                        <details>
                            <summary>Settings</summary>
                            <div class="details-body">
                                <div class="field">
                                    <label>System message</label>
                                    <textarea id="chat-system" rows="2">You are a helpful assistant.</textarea>
                                </div>
                                <div class="grid-2">
                                    <div class="field">
                                        <label>Temperature</label>
                                        <div class="range-row">
                                            <input type="range" id="chat-temp" min="0" max="2" step="0.05" value="0.7">
                                            <span class="range-value">0.70</span>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label>Max tokens</label>
                                        <div class="range-row">
                                            <input type="range" id="chat-max-tokens" min="1" max="16384" step="1" value="2048">
                                            <span class="range-value">2048</span>
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label><input type="checkbox" id="chat-audio-out"> Request audio output</label>
                                    </div>
                                </div>
                            </div>
                        </details>
                        <details>
                            <summary>Request payload</summary>
                            <div class="details-body">
                                <textarea class="payload-editor" id="chat-payload" rows="8"></textarea>
                                <div class="input-footer">
                                    <button class="btn-link" id="chat-payload-reset">Reset to form values</button>
                                </div>
                            </div>
                        </details>
                    </div>
                </div>
            </section>

            <!-- Image -->
            <section id="tab-image" class="tab-panel">
                <div class="scroll-panel">
                    <div class="field">
                        <label>Prompt</label>
                        <textarea id="img-prompt" rows="3" placeholder="Describe the image you want to generate..."></textarea>
                    </div>
                    <details>
                        <summary>Advanced</summary>
                        <div class="details-body">
                            <div class="field">
                                <label>Negative prompt</label>
                                <textarea id="img-negative" rows="2" placeholder="What to avoid..."></textarea>
                            </div>
                            <div class="grid-2">
                                <div class="field">
                                    <label>Size</label>
                                    <select id="img-size">
                                        <option value="1024x1024" selected>1024 x 1024</option>
                                        <option value="512x512">512 x 512</option>
                                        <option value="768x768">768 x 768</option>
                                        <option value="1024x768">1024 x 768</option>
                                        <option value="768x1024">768 x 1024</option>
                                    </select>
                                </div>
                                <div class="field">
                                    <label>Steps</label>
                                    <div class="range-row">
                                        <input type="range" id="img-steps" min="1" max="100" step="1" value="30">
                                        <span class="range-value">30</span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>CFG scale</label>
                                    <div class="range-row">
                                        <input type="range" id="img-cfg" min="1" max="20" step="0.5" value="7">
                                        <span class="range-value">7.0</span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Seed</label>
                                    <input type="number" id="img-seed" value="-1" placeholder="-1 = random">
                                </div>
                                <div class="field">
                                    <label>Count</label>
                                    <div class="range-row">
                                        <input type="range" id="img-count" min="1" max="4" step="1" value="1">
                                        <span class="range-value">1</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </details>
                    <details>
                        <summary>Request payload</summary>
                        <div class="details-body">
                            <textarea class="payload-editor" id="img-payload" rows="8"></textarea>
                            <div class="input-footer">
                                <button class="btn-link" id="img-payload-reset">Reset to form values</button>
                            </div>
                        </div>
                    </details>
                    <button id="img-generate" class="btn-primary">Generate</button>
                    <div id="img-error"></div>
                    <div class="gen-history" id="img-history"></div>
                    <div class="history-footer" id="img-history-footer" style="display:none">
                        <button class="btn-link" id="img-clear-history">Clear history</button>
                    </div>
                </div>
            </section>

            <!-- Video -->
            <section id="tab-video" class="tab-panel">
                <div class="scroll-panel">
                    <div class="field">
                        <label>Prompt</label>
                        <textarea id="vid-prompt" rows="3" placeholder="Describe the video you want to generate..."></textarea>
                    </div>
                    <details>
                        <summary>Advanced</summary>
                        <div class="details-body">
                            <div class="field">
                                <label>Negative prompt</label>
                                <textarea id="vid-negative" rows="2" placeholder="What to avoid..."></textarea>
                            </div>
                            <div class="grid-2">
                                <div class="field">
                                    <label>Width</label>
                                    <input type="number" id="vid-width" value="832" min="64" step="16">
                                </div>
                                <div class="field">
                                    <label>Height</label>
                                    <input type="number" id="vid-height" value="480" min="64" step="16">
                                </div>
                                <div class="field">
                                    <label>Frames</label>
                                    <div class="range-row">
                                        <input type="range" id="vid-frames" min="1" max="200" step="1" value="81">
                                        <span class="range-value">81</span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>FPS</label>
                                    <div class="range-row">
                                        <input type="range" id="vid-fps" min="1" max="60" step="1" value="16">
                                        <span class="range-value">16</span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Steps</label>
                                    <div class="range-row">
                                        <input type="range" id="vid-steps" min="1" max="100" step="1" value="40">
                                        <span class="range-value">40</span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>CFG scale</label>
                                    <div class="range-row">
                                        <input type="range" id="vid-cfg" min="1" max="20" step="0.5" value="4">
                                        <span class="range-value">4.0</span>
                                    </div>
                                </div>
                                <div class="field">
                                    <label>Seed</label>
                                    <input type="number" id="vid-seed" value="-1" placeholder="-1 = random">
                                </div>
                            </div>
                        </div>
                    </details>
                    <details>
                        <summary>Request payload</summary>
                        <div class="details-body">
                            <textarea class="payload-editor" id="vid-payload" rows="8"></textarea>
                            <div class="input-footer">
                                <button class="btn-link" id="vid-payload-reset">Reset to form values</button>
                            </div>
                        </div>
                    </details>
                    <button id="vid-generate" class="btn-primary">Generate</button>
                    <div id="vid-error"></div>
                    <div class="gen-history" id="vid-history"></div>
                    <div class="history-footer" id="vid-history-footer" style="display:none">
                        <button class="btn-link" id="vid-clear-history">Clear history</button>
                    </div>
                </div>
            </section>

            <!-- TTS -->
            <section id="tab-tts" class="tab-panel">
                <div class="scroll-panel">
                    <div class="field">
                        <label>Text</label>
                        <textarea id="tts-text" rows="5" placeholder="Enter text to synthesize..."></textarea>
                    </div>
                    <div class="grid-2">
                        <div class="field">
                            <label>Voice</label>
                            <select id="tts-voice"><option value="default">default</option></select>
                        </div>
                        <div class="field">
                            <label>Speed</label>
                            <div class="range-row">
                                <input type="range" id="tts-speed" min="0.25" max="4" step="0.05" value="1">
                                <span class="range-value">1.00</span>
                            </div>
                        </div>
                    </div>
                    <details>
                        <summary>Advanced</summary>
                        <div class="details-body">
                            <div class="grid-2">
                                <div class="field">
                                    <label>Language</label>
                                    <input type="text" id="tts-lang" placeholder="e.g. en, zh (optional)">
                                </div>
                                <div class="field">
                                    <label>Instructions</label>
                                    <input type="text" id="tts-instructions" placeholder="Model-dependent (optional)">
                                </div>
                            </div>
                        </div>
                    </details>
                    <details>
                        <summary>Request payload</summary>
                        <div class="details-body">
                            <textarea class="payload-editor" id="tts-payload" rows="8"></textarea>
                            <div class="input-footer">
                                <button class="btn-link" id="tts-payload-reset">Reset to form values</button>
                            </div>
                        </div>
                    </details>
                    <button id="tts-synth" class="btn-primary">Synthesize</button>
                    <div id="tts-error"></div>
                    <div class="gen-history" id="tts-history"></div>
                    <div class="history-footer" id="tts-history-footer" style="display:none">
                        <button class="btn-link" id="tts-clear-history">Clear history</button>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <div class="lightbox" id="lightbox">
        <button class="lb-nav lb-prev" id="lb-prev">&#8249;</button>
        <img id="lightbox-img" src="" alt="">
        <button class="lb-nav lb-next" id="lb-next">&#8250;</button>
    </div>

    <script>
    /* ------------------------------------------------------------------ */
    /* Config                                                              */
    /* ------------------------------------------------------------------ */
    const CONFIG = JSON.parse(document.getElementById('config').textContent);

    document.getElementById('model-name').textContent = CONFIG.modelShort;
    document.getElementById('model-path').textContent = CONFIG.modelId;
    document.title = CONFIG.modelShort + ' \u2014 Model UI';

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    /* ------------------------------------------------------------------ */
    /* Utilities                                                           */
    /* ------------------------------------------------------------------ */
    function escapeHtml(s) {
        return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function renderMarkdown(text) {
        if (!text) return '';
        const blocks = [];
        text = text.replace(/```(\w*)\n([\s\S]*?)```/g, (_, lang, code) => {
            blocks.push('<pre><code>' + escapeHtml(code.trimEnd()) + '</code></pre>');
            return '\x00B' + (blocks.length - 1) + '\x00';
        });
        text = escapeHtml(text);
        text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
        text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/\n/g, '<br>');
        text = text.replace(/\x00B(\d+)\x00/g, (_, i) => blocks[parseInt(i)]);
        return text;
    }

    function timeNow() {
        return new Date().toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    }

    /* Thinking/reasoning model support
       Handles: <think>, <thinking>, <|think|> (case-insensitive)
       Also handles missing opening tag (some models only emit </think>) */
    const _thinkOpenRe  = /<think(?:ing)?>|<\|think\|>/i;
    const _thinkCloseRe = /<\/think(?:ing)?>|<\|\/think\|>/i;

    function renderWithThinking(text) {
        /* 1. Opening tag present */
        const openMatch = text.match(_thinkOpenRe);
        if (openMatch) {
            const before = text.substring(0, openMatch.index);
            const after  = text.substring(openMatch.index + openMatch[0].length);
            const closeMatch = after.match(_thinkCloseRe);
            let think, response, done;
            if (closeMatch) {
                think    = after.substring(0, closeMatch.index);
                response = after.substring(closeMatch.index + closeMatch[0].length).trim();
                done = true;
            } else {
                think    = after;
                response = '';
                done = false;
            }
            let html = '';
            if (before.trim()) html += renderMarkdown(before);
            html += '<details class="think-block"' + (done ? '' : ' open') + '>'
                + '<summary>' + (done ? 'Thought process' : 'Thinking\u2026') + '</summary>'
                + '<div class="think-content">' + renderMarkdown(think) + '</div></details>';
            if (response) html += renderMarkdown(response);
            return html;
        }
        /* 2. No opening tag — model omitted it; closing tag marks end of thinking */
        const closeOnly = text.match(_thinkCloseRe);
        if (closeOnly) {
            const think    = text.substring(0, closeOnly.index);
            const response = text.substring(closeOnly.index + closeOnly[0].length).trim();
            let html = '<details class="think-block">'
                + '<summary>Thought process</summary>'
                + '<div class="think-content">' + renderMarkdown(think) + '</div></details>';
            if (response) html += renderMarkdown(response);
            return html;
        }
        return renderMarkdown(text);
    }

    function stripThinking(text) {
        /* Remove blocks with opening+closing tags */
        text = text.replace(/<think(?:ing)?>[\s\S]*?<\/think(?:ing)?>\s*/gi, '');
        text = text.replace(/<\|think\|>[\s\S]*?<\|\/think\|>\s*/gi, '');
        /* Handle missing opener: everything before first closing tag is thinking */
        text = text.replace(/^[\s\S]*?<\/think(?:ing)?>\s*/i, '');
        text = text.replace(/^[\s\S]*?<\|\/think\|>\s*/i, '');
        return text.trim();
    }

    /* Range inputs — sync display values */
    $$('input[type="range"]').forEach(input => {
        const display = input.parentElement.querySelector('.range-value');
        if (!display) return;
        const decimals = input.step.includes('.') ? input.step.split('.')[1].length : 0;
        const update = () => { display.textContent = parseFloat(input.value).toFixed(decimals); };
        input.addEventListener('input', update);
        update();
    });

    /* Auto-growing textareas */
    function autoGrow(el) {
        if (!el) return;
        el.addEventListener('input', () => {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 200) + 'px';
        });
    }
    autoGrow($('#chat-input'));

    /* ------------------------------------------------------------------ */
    /* Tabs                                                                */
    /* ------------------------------------------------------------------ */
    let ttsVoicesLoaded = false;

    $$('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            $$('.tab-btn').forEach(b => b.classList.remove('active'));
            $$('.tab-panel').forEach(p => p.classList.remove('active'));
            btn.classList.add('active');
            $('#tab-' + btn.dataset.tab).classList.add('active');
            if (btn.dataset.tab === 'tts' && !ttsVoicesLoaded) loadVoices();
        });
    });

    /* Tab filtering via allowedTabs config */
    if (CONFIG.allowedTabs) {
        const allowed = CONFIG.allowedTabs;
        let defaultVisible = false;
        $$('.tab-btn').forEach(btn => {
            if (!allowed.includes(btn.dataset.tab)) {
                btn.style.display = 'none';
                const panel = $('#tab-' + btn.dataset.tab);
                if (panel) panel.style.display = 'none';
            } else if (btn.dataset.tab === CONFIG.defaultTab) {
                defaultVisible = true;
            }
        });
        if (!defaultVisible && allowed.length) {
            const first = $(`.tab-btn[data-tab="${allowed[0]}"]`);
            if (first) first.click();
        }
    }

    if (CONFIG.defaultTab !== 'chat') {
        const btn = $(`.tab-btn[data-tab="${CONFIG.defaultTab}"]`);
        if (btn) btn.click();
    }

    /* ------------------------------------------------------------------ */
    /* Lightbox                                                            */
    /* ------------------------------------------------------------------ */
    let lightboxImages = [];
    let lightboxIndex = 0;

    function showLightboxImage() {
        if (!lightboxImages.length) return;
        $('#lightbox-img').src = lightboxImages[lightboxIndex];
        $('#lb-prev').disabled = lightboxIndex <= 0;
        $('#lb-next').disabled = lightboxIndex >= lightboxImages.length - 1;
    }

    function openLightbox(src) {
        const activePanel = $('.tab-panel.active');
        const imgs = activePanel ? activePanel.querySelectorAll('.gen-results img, .gen-history img') : [];
        lightboxImages = Array.from(imgs).map(img => img.src);
        lightboxIndex = lightboxImages.indexOf(src);
        if (lightboxIndex < 0) lightboxIndex = 0;
        showLightboxImage();
        $('#lightbox').classList.add('active');
    }

    $('#lb-prev').addEventListener('click', e => {
        e.stopPropagation();
        if (lightboxIndex > 0) { lightboxIndex--; showLightboxImage(); }
    });
    $('#lb-next').addEventListener('click', e => {
        e.stopPropagation();
        if (lightboxIndex < lightboxImages.length - 1) { lightboxIndex++; showLightboxImage(); }
    });
    $('#lightbox-img').addEventListener('click', e => e.stopPropagation());
    $('#lightbox').addEventListener('click', e => {
        if (e.target.id === 'lightbox' ) $('#lightbox').classList.remove('active');
    });
    document.addEventListener('keydown', e => {
        if (!$('#lightbox').classList.contains('active')) return;
        if (e.key === 'Escape') {
            $('#lightbox').classList.remove('active');
        } else if (e.key === 'ArrowLeft' && lightboxIndex > 0) {
            lightboxIndex--; showLightboxImage();
        } else if (e.key === 'ArrowRight' && lightboxIndex < lightboxImages.length - 1) {
            lightboxIndex++; showLightboxImage();
        }
    });

    /* ------------------------------------------------------------------ */
    /* Payload editor system                                               */
    /* ------------------------------------------------------------------ */
    function createPayloadSync(prefix, panelId, buildFn) {
        const textarea = $(`#${prefix}-payload`);
        const resetBtn = $(`#${prefix}-payload-reset`);
        const panel = $(`#tab-${panelId}`);
        let custom = false;

        function sync() {
            if (custom) return;
            try {
                textarea.value = JSON.stringify(buildFn(), null, 2);
            } catch {}
        }

        /* Listen for input on the whole panel via delegation */
        panel.addEventListener('input', e => {
            if (e.target === textarea) {
                custom = true;
            } else if (!e.target.classList.contains('payload-editor')) {
                sync();
            }
        });
        /* Also sync on change (for selects, checkboxes) */
        panel.addEventListener('change', e => {
            if (e.target !== textarea && !e.target.classList.contains('payload-editor')) {
                sync();
            }
        });

        resetBtn.addEventListener('click', () => {
            custom = false;
            sync();
        });

        /* Initial sync */
        sync();

        return {
            getPayload() {
                try { return JSON.parse(textarea.value); }
                catch (e) { throw new Error('Invalid JSON in payload editor: ' + e.message); }
            },
            isCustom() { return custom; },
            sync() { custom = false; sync(); },
        };
    }

    /* ------------------------------------------------------------------ */
    /* Payload build functions                                             */
    /* ------------------------------------------------------------------ */
    function buildChatPayload() {
        const system = $('#chat-system').value.trim();
        const temp = parseFloat($('#chat-temp').value);
        const maxTokens = parseInt($('#chat-max-tokens').value);
        const input = $('#chat-input').value.trim();
        const wantAudio = $('#chat-audio-out').checked;
        const msgs = [];
        if (system) msgs.push({ role: 'system', content: system });
        chatState.messages.forEach(m => msgs.push({ role: m.role, content: m.content }));
        if (input || chatState.files.length) {
            if (chatState.files.length) {
                const parts = [];
                for (const f of chatState.files) {
                    if (f.type.startsWith('audio/'))
                        parts.push({ type: 'input_audio', input_audio: { data: '(file data)', format: f.name.split('.').pop() } });
                    else
                        parts.push({ type: 'image_url', image_url: { url: '(file data)' } });
                }
                if (input) parts.push({ type: 'text', text: input });
                msgs.push({ role: 'user', content: parts });
            } else {
                msgs.push({ role: 'user', content: input });
            }
        }
        const body = { model: CONFIG.modelId, messages: msgs, temperature: temp, max_tokens: maxTokens, stream: !wantAudio };
        if (wantAudio) {
            body.modalities = ['text', 'audio'];
            body.audio = { voice: 'default', format: 'wav' };
        }
        return body;
    }

    function buildImagePayload() {
        const body = {
            model: CONFIG.modelId,
            prompt: $('#img-prompt').value.trim(),
            size: $('#img-size').value,
            n: parseInt($('#img-count').value),
            response_format: 'b64_json',
        };
        const neg = $('#img-negative').value.trim();
        if (neg) body.negative_prompt = neg;
        const steps = parseInt($('#img-steps').value);
        if (steps > 0) body.num_inference_steps = steps;
        const cfg = parseFloat($('#img-cfg').value);
        if (cfg > 0) body.guidance_scale = cfg;
        const seed = parseInt($('#img-seed').value);
        if (seed >= 0) body.seed = seed;
        return body;
    }

    function buildVideoPayload() {
        const body = {
            prompt: $('#vid-prompt').value.trim(),
            width: parseInt($('#vid-width').value) || 832,
            height: parseInt($('#vid-height').value) || 480,
        };
        const neg = $('#vid-negative').value.trim();
        if (neg) body.negative_prompt = neg;
        const frames = parseInt($('#vid-frames').value);
        if (frames > 0) body.num_frames = frames;
        const fps = parseInt($('#vid-fps').value);
        if (fps > 0) body.fps = fps;
        const steps = parseInt($('#vid-steps').value);
        if (steps > 0) body.num_inference_steps = steps;
        const cfg = parseFloat($('#vid-cfg').value);
        if (cfg > 0) body.guidance_scale = cfg;
        const seed = parseInt($('#vid-seed').value);
        if (seed >= 0) body.seed = seed;
        return body;
    }

    function buildTtsPayload() {
        const body = {
            model: CONFIG.modelId,
            input: $('#tts-text').value.trim(),
            voice: $('#tts-voice').value,
            speed: parseFloat($('#tts-speed').value),
            response_format: 'wav',
        };
        const lang = $('#tts-lang').value.trim();
        if (lang) body.language = lang;
        const instr = $('#tts-instructions').value.trim();
        if (instr) body.instructions = instr;
        return body;
    }


    /* ------------------------------------------------------------------ */
    /* IndexedDB persistence                                               */
    /* ------------------------------------------------------------------ */
    const DB_NAME = 'modelui-history';
    const DB_VERSION = 1;
    const STORES = { image: 'images', video: 'videos', tts: 'tts' };
    const imgHistoryData = [];
    const vidHistoryData = [];
    const ttsHistoryData = [];

    function openDB() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open(DB_NAME, DB_VERSION);
            req.onupgradeneeded = () => {
                const db = req.result;
                for (const name of Object.values(STORES)) {
                    if (!db.objectStoreNames.contains(name)) {
                        db.createObjectStore(name, { autoIncrement: true });
                    }
                }
            };
            req.onsuccess = () => resolve(req.result);
            req.onerror = () => reject(req.error);
        });
    }

    async function idbSave(storeName, entries) {
        const db = await openDB();
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        store.clear();
        for (const entry of entries) store.put(entry);
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => { db.close(); resolve(); };
            tx.onerror = () => { db.close(); reject(tx.error); };
        });
    }

    async function idbLoad(storeName) {
        const db = await openDB();
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        return new Promise((resolve, reject) => {
            const req = store.getAll();
            req.onsuccess = () => { db.close(); resolve(req.result || []); };
            req.onerror = () => { db.close(); reject(req.error); };
        });
    }

    async function idbClear(storeName) {
        const db = await openDB();
        const tx = db.transaction(storeName, 'readwrite');
        tx.objectStore(storeName).clear();
        return new Promise((resolve, reject) => {
            tx.oncomplete = () => { db.close(); resolve(); };
            tx.onerror = () => { db.close(); reject(tx.error); };
        });
    }

    /* Migrate old localStorage data to IndexedDB (one-time) */
    const _LS_KEYS = { image: 'modelui-img-history', video: 'modelui-vid-history', tts: 'modelui-tts-history' };
    async function migrateLocalStorage() {
        for (const [type, lsKey] of Object.entries(_LS_KEYS)) {
            let raw;
            try { raw = localStorage.getItem(lsKey); } catch { continue; }
            if (!raw) continue;
            try {
                let entries = JSON.parse(raw);
                if (!Array.isArray(entries)) continue;
                /* Image entries were bare base64 strings — wrap them */
                if (type === 'image') {
                    entries = entries.map(e => typeof e === 'string' ? { b64: e } : e);
                }
                await idbSave(STORES[type], entries);
                localStorage.removeItem(lsKey);
            } catch { /* best-effort */ }
        }
    }

    /* ------------------------------------------------------------------ */
    /* Generation history helper                                           */
    /* ------------------------------------------------------------------ */
    const GEN_HISTORY_MAX = 50;

    function prependGenCard(historyEl, footerEl, promptText, contentHtml, grid, time) {
        const card = document.createElement('div');
        card.className = 'gen-card';
        card.innerHTML =
            '<div class="gen-meta">' +
                '<span class="gen-prompt">' + escapeHtml(promptText) + '</span>' +
                '<span class="gen-time">' + (time || timeNow()) + '</span>' +
            '</div>' +
            '<div class="gen-results' + (grid ? ' gen-grid' : '') + '">' + contentHtml + '</div>';
        historyEl.prepend(card);
        /* Cap history */
        while (historyEl.children.length > GEN_HISTORY_MAX) {
            historyEl.removeChild(historyEl.lastChild);
        }
        footerEl.style.display = '';
        /* Wire lightbox clicks for images in this card */
        card.querySelectorAll('img').forEach(img => {
            img.addEventListener('click', () => openLightbox(img.src));
        });
    }

    /* ------------------------------------------------------------------ */
    /* Shared: add message to a chat container                             */
    /* ------------------------------------------------------------------ */
    function addMessage(container, role, content) {
        const div = document.createElement('div');
        div.className = 'message ' + role;
        div.innerHTML =
            '<div class="message-role">' + (role === 'user' ? 'You' : 'Assistant') + '</div>' +
            '<div class="message-content">' + renderMarkdown(content) + '</div>';
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
        return div;
    }

    /* ------------------------------------------------------------------ */
    /* Chat                                                                */
    /* ------------------------------------------------------------------ */
    const chatState = { messages: [], files: [], streaming: false, controller: null };

    const chatPayloadSync = createPayloadSync('chat', 'chat', buildChatPayload);

    /* File attachments */
    $('#chat-attach').addEventListener('click', () => $('#chat-file').click());
    $('#chat-file').addEventListener('change', e => {
        for (const file of e.target.files) {
            const reader = new FileReader();
            reader.onload = () => {
                chatState.files.push({ name: file.name, type: file.type, dataUrl: reader.result });
                renderChatUploads();
                chatPayloadSync.sync();
            };
            reader.readAsDataURL(file);
        }
        e.target.value = '';
    });

    function renderChatUploads() {
        const container = $('#chat-uploads');
        container.innerHTML = '';
        chatState.files.forEach((f, i) => {
            const div = document.createElement('div');
            div.className = 'upload-thumb';
            if (f.type.startsWith('image/')) {
                div.innerHTML = '<img src="' + f.dataUrl + '" alt="">';
            } else {
                div.innerHTML = '<div class="audio-badge">&#9835;</div>';
            }
            const btn = document.createElement('button');
            btn.className = 'remove-btn';
            btn.textContent = '\u00d7';
            btn.onclick = () => { chatState.files.splice(i, 1); renderChatUploads(); chatPayloadSync.sync(); };
            div.appendChild(btn);
            container.appendChild(div);
        });
    }

    async function sendChat() {
        if (chatState.streaming) {
            if (chatState.controller) chatState.controller.abort();
            return;
        }
        const input = $('#chat-input');
        const text = input.value.trim();
        const files = [...chatState.files];
        const customPayload = chatPayloadSync.isCustom();

        if (!text && !files.length && !customPayload) return;

        const container = $('#chat-messages');
        const wantAudio = $('#chat-audio-out').checked;

        let body;
        if (customPayload) {
            /* Use the manually edited payload as-is */
            try {
                body = chatPayloadSync.getPayload();
            } catch (e) {
                addMessage(container, 'assistant', 'Error: ' + e.message);
                return;
            }
            /* Show what the user typed (if anything) */
            if (text || files.length) {
                let displayText = files.map(f => '[' + f.name + ']').join(' ');
                if (text) displayText += (displayText ? ' ' : '') + text;
                addMessage(container, 'user', displayText);
            } else {
                addMessage(container, 'user', '(custom payload)');
            }
        } else {
            /* Build user content — multimodal if files attached, plain text otherwise */
            let userContent;
            if (files.length) {
                const parts = [];
                for (const f of files) {
                    if (f.type.startsWith('audio/')) {
                        const ext = f.name.split('.').pop();
                        parts.push({ type: 'input_audio', input_audio: { data: f.dataUrl, format: ext } });
                    } else {
                        parts.push({ type: 'image_url', image_url: { url: f.dataUrl } });
                    }
                }
                if (text) parts.push({ type: 'text', text: text });
                userContent = parts;
            } else {
                userContent = text;
            }

            chatState.messages.push({ role: 'user', content: userContent });
            chatPayloadSync.sync();

            try {
                body = chatPayloadSync.getPayload();
            } catch (e) {
                addMessage(container, 'assistant', 'Error: ' + e.message);
                return;
            }

            let displayText = files.map(f => '[' + f.name + ']').join(' ');
            if (text) displayText += (displayText ? ' ' : '') + text;
            addMessage(container, 'user', displayText);

            /* Build messages with real file data (payload editor uses placeholders) */
            const system = $('#chat-system').value.trim();
            const apiMessages = [];
            if (system) apiMessages.push({ role: 'system', content: system });
            apiMessages.push(...chatState.messages);
            body.messages = apiMessages;
        }

        input.value = '';
        input.style.height = 'auto';
        chatState.files = [];
        renderChatUploads();

        const assistantDiv = addMessage(container, 'assistant', '');
        const contentEl = assistantDiv.querySelector('.message-content');
        contentEl.classList.add('cursor-blink');

        chatState.streaming = true;
        const sendBtn = $('#chat-send');
        sendBtn.textContent = 'Stop';

        /* Force non-streaming when audio output is requested */
        if (wantAudio && !customPayload) {
            body.stream = false;
            body.modalities = ['text', 'audio'];
            body.audio = { voice: 'default', format: 'wav' };
        }

        const isStream = body.stream !== false;
        let fullResponse = '';
        let thinkResponse = '';
        chatState.controller = new AbortController();

        try {
            const response = await fetch('/api/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
                signal: chatState.controller.signal,
            });
            if (!response.ok) {
                const err = await response.json().catch(() => ({ error: response.statusText }));
                throw new Error(err.error?.message || err.error || JSON.stringify(err));
            }

            if (isStream) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let finished = false;
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        const data = line.slice(6).trim();
                        if (data === '[DONE]') { finished = true; break; }
                        try {
                            const delta = JSON.parse(data).choices?.[0]?.delta || {};
                            const cd = delta.content || '';
                            const rd = delta.reasoning_content || '';
                            if (cd) fullResponse += cd;
                            if (rd) thinkResponse += rd;
                            if (cd || rd) {
                                let display = fullResponse;
                                if (thinkResponse) display = '<think>' + thinkResponse + (fullResponse ? '</think>' : '') + fullResponse;
                                contentEl.innerHTML = renderWithThinking(display);
                                container.scrollTop = container.scrollHeight;
                            }
                        } catch {}
                    }
                    if (finished) break;
                }
            } else {
                const result = await response.json();
                const msg = result.choices?.[0]?.message || {};
                fullResponse = msg.content || '';
                thinkResponse = msg.reasoning_content || '';
                let display = fullResponse;
                if (thinkResponse) display = '<think>' + thinkResponse + '</think>' + fullResponse;
                contentEl.innerHTML = renderWithThinking(display);

                /* Handle audio response */
                const audioObj = msg.audio;
                if (audioObj && audioObj.data) {
                    let raw = audioObj.data;
                    if (raw.includes(',')) raw = raw.split(',')[1];
                    const bytes = atob(raw);
                    const arr = new Uint8Array(bytes.length);
                    for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
                    const blob = new Blob([arr], { type: 'audio/wav' });
                    $('#chat-audio').src = URL.createObjectURL(blob);
                }
            }
        } catch (e) {
            if (e.name !== 'AbortError') {
                fullResponse += '\n\nError: ' + e.message;
                let display = fullResponse;
                if (thinkResponse) display = '<think>' + thinkResponse + '</think>' + fullResponse;
                contentEl.innerHTML = renderWithThinking(display);
            }
        }

        contentEl.classList.remove('cursor-blink');
        chatState.messages.push({ role: 'assistant', content: stripThinking(fullResponse) });
        chatState.streaming = false;
        chatState.controller = null;
        sendBtn.textContent = 'Send';
        chatPayloadSync.sync();
    }

    $('#chat-send').addEventListener('click', sendChat);
    $('#chat-input').addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
    });
    $('#chat-clear').addEventListener('click', () => {
        chatState.messages = [];
        chatState.files = [];
        $('#chat-messages').innerHTML = '';
        $('#chat-audio').removeAttribute('src');
        renderChatUploads();
        chatPayloadSync.sync();
    });

    /* ------------------------------------------------------------------ */
    /* Image                                                               */
    /* ------------------------------------------------------------------ */
    const imgPayloadSync = createPayloadSync('img', 'image', buildImagePayload);

    async function generateImage() {
        const prompt = $('#img-prompt').value.trim();
        if (!prompt) return;

        const btn = $('#img-generate');
        const errEl = $('#img-error');
        errEl.innerHTML = '';
        btn.disabled = true;
        btn.textContent = 'Generating...';

        let body;
        try {
            body = imgPayloadSync.getPayload();
        } catch (e) {
            errEl.innerHTML = '<div class="error-msg">' + escapeHtml(e.message) + '</div>';
            btn.disabled = false;
            btn.textContent = 'Generate';
            return;
        }

        try {
            const r = await fetch('/api/images/generations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!r.ok) {
                const err = await r.json().catch(() => ({ error: r.statusText }));
                throw new Error(err.error?.message || err.error || JSON.stringify(err));
            }
            const data = await r.json();
            const b64List = [];
            for (const item of (data.data || [])) {
                if (item.b64_json) b64List.push(item.b64_json);
            }
            if (b64List.length) {
                const historyEl = $('#img-history');
                const prompt = body.prompt || '';
                const time = timeNow();
                const frag = document.createDocumentFragment();
                for (const b64 of b64List) {
                    const img = document.createElement('img');
                    img.src = 'data:image/png;base64,' + b64;
                    img.alt = '';
                    img.addEventListener('click', () => openLightbox(img.src));
                    frag.appendChild(img);
                }
                historyEl.prepend(frag);
                $('#img-history-footer').style.display = '';
                imgHistoryData.unshift(...b64List.map(b64 => ({ b64, prompt, time })));
                while (imgHistoryData.length > 200) imgHistoryData.pop();
                idbSave(STORES.image, imgHistoryData).catch(() => {});
            } else {
                errEl.innerHTML = '<div class="error-msg">No images returned</div>';
            }
        } catch (e) {
            errEl.innerHTML = '<div class="error-msg">' + escapeHtml(e.message) + '</div>';
        }
        btn.disabled = false;
        btn.textContent = 'Generate';
    }

    $('#img-generate').addEventListener('click', generateImage);
    $('#img-clear-history').addEventListener('click', () => {
        $('#img-history').innerHTML = '';
        $('#img-history-footer').style.display = 'none';
        imgHistoryData.length = 0;
        idbClear(STORES.image).catch(() => {});
    });

    /* ------------------------------------------------------------------ */
    /* Video                                                               */
    /* ------------------------------------------------------------------ */
    const vidPayloadSync = createPayloadSync('vid', 'video', buildVideoPayload);

    async function generateVideo() {
        const prompt = $('#vid-prompt').value.trim();
        if (!prompt) return;

        const btn = $('#vid-generate');
        const errEl = $('#vid-error');
        errEl.innerHTML = '';
        btn.disabled = true;
        btn.textContent = 'Generating...';

        let payload;
        try {
            payload = vidPayloadSync.getPayload();
        } catch (e) {
            errEl.innerHTML = '<div class="error-msg">' + escapeHtml(e.message) + '</div>';
            btn.disabled = false;
            btn.textContent = 'Generate';
            return;
        }

        /* /v1/videos accepts multipart form data */
        const formData = new FormData();
        for (const [key, val] of Object.entries(payload)) {
            if (val !== null && val !== undefined && val !== '') {
                formData.append(key, String(val));
            }
        }

        try {
            const r = await fetch('/api/videos', {
                method: 'POST',
                body: formData,
            });
            if (!r.ok) {
                const err = await r.json().catch(() => ({ error: r.statusText }));
                throw new Error(err.error?.message || err.error || JSON.stringify(err));
            }
            const data = await r.json();
            let videoHtml = '';
            let videoB64 = null;
            for (const item of (data.data || [])) {
                if (item.b64_json) {
                    videoB64 = item.b64_json;
                    const binary = atob(item.b64_json);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                    const blob = new Blob([bytes], { type: 'video/mp4' });
                    const url = URL.createObjectURL(blob);
                    videoHtml += '<video controls src="' + url + '"></video>';
                }
            }
            if (videoHtml) {
                const time = timeNow();
                prependGenCard(
                    $('#vid-history'), $('#vid-history-footer'),
                    prompt, videoHtml, false, time
                );
                vidHistoryData.push({ prompt, time, video: videoB64 });
                idbSave(STORES.video, vidHistoryData).catch(() => {});
            } else {
                errEl.innerHTML = '<div class="error-msg">No video returned</div>';
            }
        } catch (e) {
            errEl.innerHTML = '<div class="error-msg">' + escapeHtml(e.message) + '</div>';
        }
        btn.disabled = false;
        btn.textContent = 'Generate';
    }

    $('#vid-generate').addEventListener('click', generateVideo);
    $('#vid-clear-history').addEventListener('click', () => {
        $('#vid-history').innerHTML = '';
        $('#vid-history-footer').style.display = 'none';
        vidHistoryData.length = 0;
        idbClear(STORES.video).catch(() => {});
    });

    /* ------------------------------------------------------------------ */
    /* TTS                                                                 */
    /* ------------------------------------------------------------------ */
    const ttsPayloadSync = createPayloadSync('tts', 'tts', buildTtsPayload);

    async function loadVoices() {
        try {
            const r = await fetch('/api/audio/voices');
            if (r.ok) {
                const data = await r.json();
                const voices = Array.isArray(data) ? data : (data.voices || []);
                const sel = $('#tts-voice');
                if (voices.length) {
                    sel.innerHTML = '';
                    for (const v of voices) {
                        const name = typeof v === 'string' ? v : (v.name || v.id || String(v));
                        sel.innerHTML += '<option value="' + escapeHtml(name) + '">' + escapeHtml(name) + '</option>';
                    }
                }
            }
        } catch {}
        ttsVoicesLoaded = true;
        ttsPayloadSync.sync();
    }

    async function synthesize() {
        const text = $('#tts-text').value.trim();
        if (!text) return;

        const btn = $('#tts-synth');
        const errEl = $('#tts-error');
        errEl.innerHTML = '';
        btn.disabled = true;
        btn.textContent = 'Synthesizing...';

        let body;
        try {
            body = ttsPayloadSync.getPayload();
        } catch (e) {
            errEl.innerHTML = '<div class="error-msg">' + escapeHtml(e.message) + '</div>';
            btn.disabled = false;
            btn.textContent = 'Synthesize';
            return;
        }

        try {
            const r = await fetch('/api/audio/speech', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body),
            });
            if (!r.ok) {
                const err = await r.json().catch(() => ({ error: r.statusText }));
                throw new Error(err.error?.message || err.error || JSON.stringify(err));
            }
            const blob = await r.blob();
            const url = URL.createObjectURL(blob);
            const time = timeNow();
            prependGenCard(
                $('#tts-history'), $('#tts-history-footer'),
                text,
                '<audio controls autoplay src="' + url + '"></audio>',
                false, time
            );
            /* Persist as data URI */
            const fr = new FileReader();
            fr.onload = () => {
                ttsHistoryData.push({ prompt: text, time, audio: fr.result });
                idbSave(STORES.tts, ttsHistoryData).catch(() => {});
            };
            fr.readAsDataURL(blob);
        } catch (e) {
            errEl.innerHTML = '<div class="error-msg">' + escapeHtml(e.message) + '</div>';
        }
        btn.disabled = false;
        btn.textContent = 'Synthesize';
    }

    $('#tts-synth').addEventListener('click', synthesize);
    $('#tts-clear-history').addEventListener('click', () => {
        $('#tts-history').innerHTML = '';
        $('#tts-history-footer').style.display = 'none';
        ttsHistoryData.length = 0;
        idbClear(STORES.tts).catch(() => {});
    });


    /* ------------------------------------------------------------------ */
    /* Restore history from IndexedDB                                      */
    /* ------------------------------------------------------------------ */
    (async function restoreHistory() {
        await migrateLocalStorage();

        /* Images — array of { b64, prompt?, time? } objects */
        const imgEntries = await idbLoad(STORES.image).catch(() => []);
        imgHistoryData.push(...imgEntries);
        if (imgEntries.length) {
            const historyEl = $('#img-history');
            for (const entry of imgEntries) {
                const b64 = typeof entry === 'string' ? entry : entry.b64;
                if (!b64) continue;
                const img = document.createElement('img');
                img.src = 'data:image/png;base64,' + b64;
                img.alt = '';
                img.addEventListener('click', () => openLightbox(img.src));
                historyEl.appendChild(img);
            }
            $('#img-history-footer').style.display = '';
        }

        /* Videos */
        const vidEntries = await idbLoad(STORES.video).catch(() => []);
        vidHistoryData.push(...vidEntries);
        for (const entry of vidEntries) {
            let html = '';
            if (entry.video) {
                try {
                    const binary = atob(entry.video);
                    const bytes = new Uint8Array(binary.length);
                    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
                    const blob = new Blob([bytes], { type: 'video/mp4' });
                    html = '<video controls src="' + URL.createObjectURL(blob) + '"></video>';
                } catch {
                    html = '<div class="error-msg">Video expired \u2014 regenerate</div>';
                }
            } else {
                html = '<div class="error-msg">Video expired \u2014 regenerate</div>';
            }
            prependGenCard($('#vid-history'), $('#vid-history-footer'), entry.prompt, html, false, entry.time);
        }

        /* TTS */
        const ttsEntries = await idbLoad(STORES.tts).catch(() => []);
        ttsHistoryData.push(...ttsEntries);
        for (const entry of ttsEntries) {
            let html = '';
            if (entry.audio) {
                html = '<audio controls src="' + entry.audio + '"></audio>';
            } else {
                html = '<div class="error-msg">Audio expired \u2014 regenerate</div>';
            }
            prependGenCard($('#tts-history'), $('#tts-history-footer'), entry.prompt, html, false, entry.time);
        }
    })();
    </script>
</body>
</html>
